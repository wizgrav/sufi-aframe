<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pala Pala</title>
    <meta name="description" content="Music And Motion">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">


<script src="https://aframe.io/releases/0.4.0/aframe.min.js"></script>

<script src="components/aframe-fence-component.js"></script>
<script src="components/aframe-animation-component.js"></script>
<script src="components/aframe-audioanalyser-component.js"></script>
<script src="components/aframe-extras.controls.js"></script>
<script src="components/aframe-extras.primitives.js"></script>
<script src="components/aframe-randomizer-components.js"></script>
<script src="components/aframe-terrain-model-component.min.js"></script>
<script src="js/audioanalyser-waveform.js"></script>
<script src="js/audioanalyser-volume-scale.js"></script>
<script src="js/audioanalyser-volume-radius.js"></script>
<script src="js/ocean-plane.js"></script>
<script src="js/clubber.min.js"></script>
<script src="js/clubberize.js"></script>




    <!-- livereload ~/SufiPlayer/sufi-aframe -p 8000 -->

  </head>
  <body>


<script>

AFRAME.registerSystem('clubber', {
  init: function () {
    this.clubber = new Clubber();
    this.clubber.listen(document.querySelector("audio"));
    this.func = Clubberize(this.clubber, "https://wizgrav.github.io/clubber/tool/?tool=1&t0=0123&r0=16,48,48,128&s0=0.1,0.1,0.1,0.1&a0=1,1,1,1&t1=0123&r1=48,64,48,128&s1=0.1,0.1,0.1,0.1&a1=1,1,1,1&t2=0123&r2=64,80,48,128&s2=0.1,0.1,0.1,0.1&a2=1,1,1,1&t3=0123&r3=80,112,48,128&s3=0.1,0.1,0.1,0.1&a3=1,1,1,1&red=smoothstep(iMusic%5B0%5D.z%2C%201.33%2C%20length(iMusic%5B0%5D.xw))&green=smoothstep(iMusic%5B1%5D.z%2C%201.33%2C%20length(iMusic%5B1%5D.xw))&blue=smoothstep(iMusic%5B2%5D.z%2C%201.33%2C%20length(iMusic%5B2%5D.xw))&alpha=smoothstep(iMusic%5B3%5D.z%2C%201.33%2C%20length(iMusic%5B3%5D.xw))&track=https%3A%2F%2Fsoundcloud.com%2Fyoussef-ali-6%2Fzorba-the-greek");
  },
  
  getData: function (time) {
    if(this.lastTime === time) return this.dt;
    this.clubber.update(time);
    this.dt = this.func(time/1000);
    this.lastTime = time;
    return this.dt;
  },
  
  getSpectrum: function (time) {
    this.getData(time);
    return this.clubber.notes;
  }
});
                         
AFRAME.registerComponent('wall-jitter1', {
  init: function () {
    var SCALER = [20.2, 20.4, 20, 20.6, 20.8, 21,
                  21.2, 21.4, 21.6, 19.8, 19.6, 19.4, 19.2, 19];
    var ZROT = [0, 0.2, 0.4, 0.6, 0.8, 1, 359.8, 359.6, 359.4, 359.2, 359,
                358.8, 358.6, 358.4, 1.2, 1.4, 1.6];
    this.el.addEventListener('click', function (evt) {
      var randomIndex = Math.floor(Math.random() * SCALER.length);
      var randomIndex2 = Math.floor(Math.random() * SCALER.length);
      var randomRot = Math.floor(Math.random() * ZROT.length);
      var sida = document.querySelector('#sidea');
      sida.setAttribute('geometry', 'width', SCALER[randomIndex]);
      sida.setAttribute('geometry', 'height', SCALER[randomIndex2]);
      sida.setAttribute('rotation', {x:0, y:270, z:ZROT[randomRot]});
    });
  }
});

AFRAME.registerComponent('wall-jitter2', {
  init: function () {
    var SCALER = [20.2, 20.4, 20, 20.6, 20.8, 21,
                  21.2, 21.4, 21.6, 19.8, 19.6, 19.4, 19.2, 19];
    var ZROT = [180, 180.2, 180.4, 180.6, 180.8, 181, 179.8, 179.6, 179.4, 179.2, 179,
                178.8, 178.6, 178.4, 181.2, 181.4, 181.6];
    this.el.addEventListener('click', function (evt) {
      var randomIndex = Math.floor(Math.random() * SCALER.length);
      var randomIndex2 = Math.floor(Math.random() * SCALER.length);
      var randomRot = Math.floor(Math.random() * ZROT.length);
      var sidb = document.querySelector('#sideb');
      sidb.setAttribute('geometry', 'width', SCALER[randomIndex2]);
      sidb.setAttribute('geometry', 'height', SCALER[randomIndex]);
      sidb.setAttribute('rotation', {x:0, y:90, z:ZROT[randomRot]});
    });
  }
});

</script>


<a-scene fog antialias="true">

<!--Load audio and visual assets. -->
<!-- GET LAZY LOADER FOR OCEAN? -->

    <a-assets timeout="4000">

<!-- Blank "Dummy" Audio File
    <audio id="blank" src="assets/blank.mp3">
  -->
    <audio id="datura" src="assets/datura2.mp3" preload="auto" autoplay>
    <img id="pala" src="assets/palav2.png">
    <img id="texture" src="assets/texturec2.png">
    <img id="water-normal" src="https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/waternormals.jpg" crossorigin="anonymous" />
    <img id="skysphere" src="assets/palav2.png" crossorigin="anonymous" />
    <a-mixin id="wallyA" material="src: #pala; opacity: 1">
    <a-mixin id="sides" material="src: #pala;">
    <a-mixin id="rando" material="opacity: .4"
     random-color="min: .91 .36 .27; max: .91 .36 .27"
     animation="property: random-color.max; easing: easeInSine; dur: 100; to: 1 1 1; startEvents: click">

<!-- AUDIO STEMS
     <audio id="bass" src="mp3s/bass.mp3" autoplay="false">
     <audio id="drums" src="mp3s/drums.mp3" autoplay="false">
     <audio id="guitarA" src="mp3s/guitarA.mp3" autoplay="false">
     <audio id="guitarB" src="mp3s/guitarB.mp3" autoplay="false">
-->
    </a-assets>


<!--Create player's position and controls via camera.

Add a "FENCE" to prevent walking through walls.-->
<!-- fence="width: 19.8; depth: 19; x0: 0; z0: 0" -->


<a-camera id="camera" position="0 5 3" >
<a-entity raycaster="objects: .clickable; interval: 250" cursor></a-entity>
      </a-camera>


<!-- sound -->

<a-entity id="dat1" sound="src: #datura" position="0 3 0"
</a-entity>

<a-entity id="analyser"
 
 rotation="90 45 0"
 position="0 22 0"
>
</a-entity>


<!-- Stems
For some reason, if these aren't commented out,
they push the camera down to the ocean floor... -->

<!--
<a-entity id="stemA" sound="src: #guitarA" position="7 5 -5"
</a-entity>
<a-entity id="stemB" sound="src: #drums" position="-7 5 -5"
</a-entity>
<a-entity id="stemC" sound="src: #datura" position="7 5 5"
</a-entity>
<a-entity id="stemD" sound="src: #datura" position="-7 5 5"
</a-entity>
-->


<!-- "speakers" -->

<a-cone id="coneA" color="#E35" radius-bottom="1.5" radius-top="0.5" height="1.5" open-ended="false" position="7 -.6 -5.5" rotation="180 0 0" metalness=".7"
 
 audioanalyser-volume-radius="multiplier: 3; which: red; analyserEl: #analyser"
 side="double" ></a-cone>

<a-cone id="coneB" color="#547" radius-bottom="1.5" radius-top="0.5" height="1.5" open-ended="false" position="-7 -.6 -5.5" rotation="180 0 0" metalness=".7"
 
 audioanalyser-volume-radius="multiplier: 3; which: green;  analyserEl: #analyser"
 side="double" ></a-cone>

<a-cone id="coneC" color="#498" radius-bottom="1.5" radius-top="0.5" height="1.5" open-ended="false" position="7 -.6 5.5" rotation="180 0 0" metalness=".7"
 
 audioanalyser-volume-radius="multiplier: 3; which: blue;  analyserEl: #analyser"
 side="double" ></a-cone>

<a-cone id="coneD" color="#D86" radius-bottom="1.5" radius-top="0.5" height="1.5" open-ended="false" position="-7 -.6 5.5" rotation="180 0 0" metalness=".7"
 
 audioanalyser-volume-radius="multiplier: 3; which: alpha;  analyserEl: #analyser"
 side="double" ></a-cone>

<!-- water for walls-->
<a-ocean class="clickable" rotation="0, 0, 0" position="0 -5 -10" width="22" depth="50" density="40"

 audioanalyser-volume-scale="multiplier: 10; which: blue; " mixin="wallyA" >
 <a-animation attribute="rotation"
              dur="5000"
              fill="forwards"
              to="-90 0 0"
              delay="184000"></a-animation>
 <a-animation attribute="position"
              dur="3000"
              fill="forwards"
              to="0 0 -10"
              delay="186000"></a-animation>

</a-ocean>
<a-ocean class="clickable" rotation="0, 180, 180" position="0 -5 10" width="22" depth="50" density="40"
 
 audioanalyser-volume-scale="multiplier: 10; which: blue;  analyserEl: #analyser" mixin="wallyA" >
 <a-animation attribute="rotation"
              dur="5000"
              fill="forwards"
              to="-90 180 180"
              delay="184000"></a-animation>
  <a-animation attribute="position"
              dur="3000"
              fill="forwards"
              to="0 0 10"
              delay="186000"></a-animation>

</a-ocean>

<!-- Flat walls with clickable art/changes -->

<a-plane id="sidea" class="clickable" mixin="sides" width="20" height="20" rotation="0 270 0" position="10 10 0" >
 <a-animation attribute="position"
              dur="5000"
              fill="forwards"
              to="15 -5 0"
              delay="90000"></a-animation>
</a-plane>
<a-plane id="sideb" class="clickable" mixin="sides" width="20" height="20" rotation="0 90 180" position="-10 10 0">
 <a-animation attribute="position"
              dur="5000"
              fill="forwards"
              to="-15 -5 0"
              delay="90000"></a-animation>
</a-plane>

<a-plane id="wal1" wall-jitter1 mixin="rando" class="clickable" width="20" height="20" rotation="0 270 0" position="9.75 10 0">
 <a-animation attribute="position"
              dur="5000"
              fill="forwards"
              to="14.75 -5 0"
              delay="90000"></a-animation>
</a-plane>
<a-plane id="wal2" wall-jitter2 mixin="rando" class="clickable" width="20" height="20" rotation="0 90 180" position="-9.75 10 0">
 <a-animation attribute="position"
              dur="5000"
              fill="forwards"
              to="-14.75 -5 0"
              delay="90000"></a-animation>
</a-plane>


<!-- the actual ocean -->

<a-ocean-plane width="20" height="20" position="0 -5 0" material="normalMap: #water-normal; sphericalEnvMap: #skysphere;"></a-ocean-plane>


<!-- floor-->

  <a-plane class="clickable" rotation="-90 0 0" position="0 0 0" width="20" height="20" material="src: #texture; repeat: 100 20;"
    >
    <a-animation attribute="position"
                 dur="2000"
                 fill="forwards"
                 to="0 -100 0"
                 delay="187000"></a-animation>
    <a-animation attribute="rotation"
                 dur="10000"
                 fill="forwards"
                 to="-90 90 0"
                 delay="60000"></a-animation>
  </a-plane>


<!-- Temporary ceiling;
  this is to block the viz element in the sky,
  and to more gradually bring it in -->

<a-plane rotation="90 0 0" position="0 20 0" width="30" height="30" color="black" material="opacity: 1">
 <a-animation attribute="opacity"
             dur="5000"
             fill="forwards"
             to="0"
             delay="33000"></a-animation>
</a-plane>

<!-- Island Terrain (Kipahulu region; Maui, Hawaii) -->

  <a-entity position="0 -20 0" terrain-model='DEM: url(assets/kip-sq-scaled.bin); texture: url(assets/kip-color3.png); planeWidth: 128; planeHeight: 128; segmentsWidth: 199; segmentsHeight: 199; zPosition: 18;'>
    <a-animation attribute="position"
                dur="2000"
                fill="forwards"
                to="0 -1.5 0"
                delay="186000"></a-animation>
  </a-entity>

<!-- light-->

<a-light type="ambient" color="#fff" intensity=".5">
 <a-animation attribute="intensity"
              dur="1000"
              fill="forwards"
              to="1"
              delay="2000"></a-animation>
</a-light>

<!-- sky-->

 <a-sky id="sky1" color="black">
</a-sky>

</a-scene>

  </body>
</html>
